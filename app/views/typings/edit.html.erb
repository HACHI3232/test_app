<div id="t-container">
  <div id="word"></div>
  <input type="text" id="input" oninput="checkInput()" autofocus>
</div>
<div class="q-wrap">
  <div class="q-wrap">
    <div id="mean"></div>
  </div>
  <div class="character"><%= image_tag("k-#{@character.level}.gif")%></div>
  <div class="keyboard-section">
    <input class="input" placeholder="Tap on the virtual keyboard to start" />
    <div class="simple-keyboard"></div>
  </div>
  <%= link_to"結果","result" %>
</div>
<script>
  const dictionaries = <%= raw @random_posts&.to_json || [].to_json %>;
  let currentWordIndex = 0;
  const input = document.getElementById("input");
  const meanDom = document.getElementById("mean");
  let currentFieldValue = input.value;
  let successCount = 0;
  let failedCount = 0;

  function displayWordAndMean(dictionary, index=0) {
    if (!dictionary) return null;

    word.innerHTML = dictionary.word;
    input.placeholder = dictionary.word;
    meanDom.innerHTML = dictionary.mean;
  }

  function checkInput() {
    currentFieldValue = currentFieldValue += input.value;

    if (!dictionaries[currentWordIndex] || (input.value.length != dictionaries[currentWordIndex].word.length)) return;

    if (input.value == dictionaries[currentWordIndex].word) {
      successCount++;
      currentWordIndex++;
      input.value = "";
    } else {
      failedCount++;
      currentWordIndex++;
      input.value = "";
      displayWordAndMean(dictionaries[currentWordIndex]);
    }

    if (dictionaries[currentWordIndex]) {
      // 成功した時に次があれば表示
      displayWordAndMean(dictionaries[currentWordIndex]);
    } else {
      // なければresultにリダイレクト
      window.location.href = `/typings/result?success=${successCount}&failed=${failedCount}`;
    }
  }

  displayWordAndMean(dictionaries[currentWordIndex]);
</script>
